{% extends "base.html" %}

{% block title %}Pictionary - GameLab{% endblock %}

{% block content %}
<style>
    .pictionary-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .game-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .room-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .game-area {
        display: grid;
        grid-template-columns: 1fr 250px;
        gap: 20px;
    }
    
    .canvas-section {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
    }
    
    .drawing-tools {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    
    .tool-btn {
        padding: 8px 15px;
        border: 2px solid #dee2e6;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .tool-btn:hover {
        background: #f8f9fa;
    }
    
    .tool-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .color-picker {
        display: flex;
        gap: 5px;
    }
    
    .color-btn {
        width: 30px;
        height: 30px;
        border: 2px solid #dee2e6;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .color-btn:hover {
        transform: scale(1.1);
    }
    
    .color-btn.active {
        border-width: 3px;
        border-color: #000;
    }
    
    #drawingCanvas {
        border: 2px solid #dee2e6;
        cursor: crosshair;
        display: block;
        margin: 0 auto;
        background: white;
        touch-action: none;
    }
    
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .word-display {
        background: #fff3cd;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        letter-spacing: 5px;
    }
    
    .players-list {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
    }
    
    .player-item {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .player-item.drawing {
        background: #d1ecf1;
        font-weight: bold;
    }
    
    .player-item.guessed {
        background: #d4edda;
    }
    
    .chat-section {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        height: 300px;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
        padding: 10px;
        border-radius: 5px;
    }
    
    .chat-message {
        margin: 5px 0;
        padding: 5px;
    }
    
    .chat-message.correct {
        background: #d4edda;
        color: #155724;
        font-weight: bold;
        border-radius: 3px;
    }
    
    .chat-input-group {
        display: flex;
        gap: 5px;
    }
    
    .timer {
        background: #dc3545;
        color: white;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
    }
    
    .timer.warning {
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
    }
    
    @media (max-width: 768px) {
        .game-area {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="pictionary-container">
    <div class="game-header">
        <h1>üé® Pictionary</h1>
        <div id="roomInfo" class="room-info" style="display: none;">
            <strong>Room Code:</strong> <span id="roomCode"></span> |
            <strong>Round:</strong> <span id="currentRound">0</span>/<span id="maxRounds">0</span>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobbyScreen">
        <div style="max-width: 500px; margin: 0 auto;">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Join or Create Game</h3>
                    
                    <div class="mb-3">
                        <label class="form-label">Your Name</label>
                        <input type="text" class="form-control" id="playerName" placeholder="Enter your name" value="{{ user }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Room Code (optional)</label>
                        <input type="text" class="form-control" id="roomCodeInput" placeholder="Enter room code to join">
                    </div>
                    
                    <button class="btn btn-primary w-100 mb-2" onclick="joinRoom()">Join Room</button>
                    <button class="btn btn-success w-100" onclick="createRoom()">Create New Room</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Waiting Room -->
    <div id="waitingRoom" style="display: none;">
        <div class="card">
            <div class="card-body">
                <h3>Waiting for players...</h3>
                <p><strong>Room Code:</strong> <span id="waitingRoomCode"></span></p>
                
                <div id="playersList" class="mb-3"></div>
                
                <button class="btn btn-primary" id="startGameBtn" onclick="startGame()" style="display: none;">Start Game</button>
                <button class="btn btn-secondary" onclick="leaveRoom()">Leave Room</button>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" style="display: none;">
        <div class="timer" id="timer">60</div>
        
        <div class="game-area">
            <div class="canvas-section">
                <div id="roleMessage" class="alert alert-info text-center mb-3"></div>
                
                <div id="drawingTools" class="drawing-tools" style="display: none;">
                    <button class="tool-btn active" data-tool="pen" onclick="selectTool('pen')">‚úèÔ∏è Pen</button>
                    <button class="tool-btn" data-tool="eraser" onclick="selectTool('eraser')">üßπ Eraser</button>
                    <button class="tool-btn" onclick="clearCanvas()">üóëÔ∏è Clear</button>
                    
                    <div class="color-picker">
                        <div class="color-btn active" style="background: black" onclick="selectColor('black')"></div>
                        <div class="color-btn" style="background: red" onclick="selectColor('red')"></div>
                        <div class="color-btn" style="background: blue" onclick="selectColor('blue')"></div>
                        <div class="color-btn" style="background: green" onclick="selectColor('green')"></div>
                        <div class="color-btn" style="background: yellow" onclick="selectColor('yellow')"></div>
                        <div class="color-btn" style="background: orange" onclick="selectColor('orange')"></div>
                        <div class="color-btn" style="background: purple" onclick="selectColor('purple')"></div>
                    </div>
                    
                    <label>Size: <input type="range" id="brushSize" min="1" max="20" value="3"></label>
                </div>
                
                <canvas id="drawingCanvas" width="800" height="600"></canvas>
            </div>
            
            <div class="sidebar">
                <div class="word-display" id="wordDisplay">_ _ _ _</div>
                
                <div class="players-list">
                    <h5>Players</h5>
                    <div id="gamePlayersList"></div>
                </div>
                
                <div class="chat-section">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-group">
                        <input type="text" class="form-control" id="guessInput" placeholder="Type your guess...">
                        <button class="btn btn-primary" onclick="submitGuess()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Turn End Modal -->
<div id="turnEndModal" class="modal">
    <div class="modal-content text-center">
        <h3>‚è∞ Time's Up!</h3>
        <p>The word was: <strong id="revealedWord"></strong></p>
        <div id="turnScores"></div>
        <button class="btn btn-primary" onclick="nextTurn()">Next Turn</button>
    </div>
</div>

<!-- Game Over Modal -->
<div id="gameOverModal" class="modal">
    <div class="modal-content text-center">
        <h2>üéâ Game Over!</h2>
        <div id="finalScores"></div>
        <button class="btn btn-primary" onclick="location.reload()">Play Again</button>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    let roomCode = null;
    let playerId = null;
    let isHost = false;
    let isDrawing = false;
    let currentTool = 'pen';
    let currentColor = 'black';
    let canvas = null;
    let ctx = null;
    let drawing = false;
    let lastX = 0;
    let lastY = 0;
    let timerInterval = null;

    // Initialize canvas
    document.addEventListener('DOMContentLoaded', function() {
        canvas = document.getElementById('drawingCanvas');
        ctx = canvas.getContext('2d');
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events for mobile
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDrawing);
        
        // Enter key to submit guess
        document.getElementById('guessInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') submitGuess();
        });
    });

    function createRoom() {
        const playerName = document.getElementById('playerName').value.trim() || 'Player';
        socket.emit('create_pictionary_room', {
            player_name: playerName,
            time_limit: 60,
            max_rounds: 3,
            difficulty: 'medium'
        });
    }

    function joinRoom() {
        const playerName = document.getElementById('playerName').value.trim() || 'Player';
        const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
        
        if (!code) {
            alert('Please enter a room code');
            return;
        }
        
        socket.emit('join_pictionary_room', {
            room_code: code,
            player_name: playerName
        });
    }

    function startGame() {
        socket.emit('start_pictionary_game', { room_code: roomCode });
    }

    function leaveRoom() {
        if (roomCode) {
            socket.emit('leave_pictionary_room', { room_code: roomCode });
        }
        location.reload();
    }

    function selectTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tool === tool);
        });
    }

    function selectColor(color) {
        currentColor = color;
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        socket.emit('draw_action', {
            room_code: roomCode,
            action: { type: 'clear' }
        });
    }

    function startDrawing(e) {
        if (!isDrawing) return;
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    }

    function draw(e) {
        if (!isDrawing || !drawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        drawLine(lastX, lastY, x, y);
        
        socket.emit('draw_action', {
            room_code: roomCode,
            action: {
                type: currentTool,
                fromX: lastX,
                fromY: lastY,
                toX: x,
                toY: y,
                color: currentColor,
                size: document.getElementById('brushSize').value
            }
        });
        
        lastX = x;
        lastY = y;
    }

    function stopDrawing() {
        drawing = false;
    }

    function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                         e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }

    function drawLine(fromX, fromY, toX, toY) {
        ctx.strokeStyle = currentTool === 'eraser' ? 'white' : currentColor;
        ctx.lineWidth = document.getElementById('brushSize').value;
        ctx.beginPath();
        ctx.moveTo(fromX, fromY);
        ctx.lineTo(toX, toY);
        ctx.stroke();
    }

    function submitGuess() {
        const guess = document.getElementById('guessInput').value.trim();
        if (!guess) return;
        
        socket.emit('submit_guess', {
            room_code: roomCode,
            guess: guess
        });
        
        document.getElementById('guessInput').value = '';
    }

    function nextTurn() {
        document.getElementById('turnEndModal').classList.remove('active');
        if (isHost) {
            socket.emit('next_turn', { room_code: roomCode });
        }
    }

    function updatePlayersList(players, gameScreen = false) {
        const listElement = document.getElementById(gameScreen ? 'gamePlayersList' : 'playersList');
        listElement.innerHTML = players.map(p => `
            <div class="player-item ${p.is_drawing ? 'drawing' : ''}">
                <span>${p.name} ${p.is_host ? 'üëë' : ''}</span>
                <span>${gameScreen ? p.score + ' pts' : (p.ready ? '‚úÖ' : '‚è≥')}</span>
            </div>
        `).join('');
    }

    function addChatMessage(message, isCorrect = false) {
        const chatMessages = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = 'chat-message' + (isCorrect ? ' correct' : '');
        div.textContent = message;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function startTimer(seconds) {
        clearInterval(timerInterval);
        let timeLeft = seconds;
        const timerElement = document.getElementById('timer');
        
        timerInterval = setInterval(() => {
            timeLeft--;
            timerElement.textContent = timeLeft;
            
            if (timeLeft <= 10) {
                timerElement.classList.add('warning');
            }
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (isDrawing) {
                    socket.emit('time_up', { room_code: roomCode });
                }
            }
        }, 1000);
    }

    // Socket event handlers
    socket.on('pictionary_room_created', function(data) {
        roomCode = data.room_code;
        playerId = data.player_id;
        isHost = true;
        
        document.getElementById('lobbyScreen').style.display = 'none';
        document.getElementById('waitingRoom').style.display = 'block';
        document.getElementById('waitingRoomCode').textContent = roomCode;
        document.getElementById('startGameBtn').style.display = 'block';
        
        updatePlayersList(data.players);
    });

    socket.on('pictionary_room_joined', function(data) {
        roomCode = data.room_code;
        playerId = data.player_id;
        
        document.getElementById('lobbyScreen').style.display = 'none';
        document.getElementById('waitingRoom').style.display = 'block';
        document.getElementById('waitingRoomCode').textContent = roomCode;
        
        updatePlayersList(data.players);
    });

    socket.on('pictionary_player_joined', function(data) {
        updatePlayersList(data.players);
    });

    socket.on('turn_start_drawer', function(data) {
        isDrawing = true;
        
        document.getElementById('waitingRoom').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        document.getElementById('roomInfo').style.display = 'block';
        document.getElementById('roomCode').textContent = roomCode;
        document.getElementById('currentRound').textContent = data.round;
        document.getElementById('maxRounds').textContent = data.max_rounds;
        
        document.getElementById('roleMessage').textContent = `üé® You are drawing: ${data.word}`;
        document.getElementById('wordDisplay').textContent = data.word;
        document.getElementById('drawingTools').style.display = 'flex';
        document.getElementById('guessInput').disabled = true;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        startTimer(data.time_limit);
    });

    socket.on('turn_start_guesser', function(data) {
        isDrawing = false;
        
        document.getElementById('waitingRoom').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        document.getElementById('roomInfo').style.display = 'block';
        document.getElementById('roomCode').textContent = roomCode;
        document.getElementById('currentRound').textContent = data.round;
        document.getElementById('maxRounds').textContent = data.max_rounds;
        
        document.getElementById('roleMessage').textContent = `üîç ${data.drawer_name} is drawing!`;
        document.getElementById('wordDisplay').textContent = data.word_hint;
        document.getElementById('drawingTools').style.display = 'none';
        document.getElementById('guessInput').disabled = false;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        startTimer(data.time_limit);
    });

    socket.on('drawing_update', function(data) {
        const action = data.action;
        
        if (action.type === 'clear') {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        } else {
            ctx.strokeStyle = action.type === 'eraser' ? 'white' : action.color;
            ctx.lineWidth = action.size;
            ctx.beginPath();
            ctx.moveTo(action.fromX, action.fromY);
            ctx.lineTo(action.toX, action.toY);
            ctx.stroke();
        }
    });

    socket.on('player_guessed', function(data) {
        addChatMessage(`${data.player_name}: ${data.guess}`);
    });

    socket.on('correct_guess', function(data) {
        addChatMessage(`üéâ ${data.player_name} guessed correctly! +${data.points} points`, true);
        updatePlayersList(data.players, true);
    });

    socket.on('turn_end', function(data) {
        clearInterval(timerInterval);
        document.getElementById('revealedWord').textContent = data.word;
        document.getElementById('turnScores').innerHTML = data.players
            .sort((a, b) => b.score - a.score)
            .map(p => `<p>${p.name}: ${p.score} points</p>`)
            .join('');
        document.getElementById('turnEndModal').classList.add('active');
        
        updatePlayersList(data.players, true);
    });

    socket.on('game_over', function(data) {
        clearInterval(timerInterval);
        document.getElementById('finalScores').innerHTML = data.final_results
            .map(r => `<p>${r.rank}. ${r.name}: ${r.score} points</p>`)
            .join('');
        document.getElementById('gameOverModal').classList.add('active');
    });

    socket.on('pictionary_error', function(data) {
        alert(data.message);
    });
</script>
{% endblock %}
