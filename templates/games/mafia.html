{% extends "base.html" %}

{% block title %}Mafia Game - Futuristic Games Hub{% endblock %}

{% block extra_head %}
<style>
/* Mafia Game Styles */
.mafia-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.game-header h1 {
    color: #00ff00;
    text-shadow: 0 0 10px #00ff00;
}

.lobby-screen, .game-screen {
    background: rgba(0, 20, 40, 0.8);
    border: 2px solid #00ff00;
    border-radius: 10px;
    padding: 30px;
    margin: 20px 0;
}

.join-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.join-controls input {
    flex: 1;
    padding: 12px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #00ff00;
    color: #00ff00;
    border-radius: 5px;
    font-size: 16px;
}

.btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, #00ff00, #00cc00);
    color: #000;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}

.btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px #00ff00;
}

.btn-secondary {
    background: linear-gradient(135deg, #666, #444);
    color: #fff;
}

.players-list {
    margin: 20px 0;
}

.player-card {
    background: rgba(0, 50, 100, 0.6);
    border: 1px solid #00ff00;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.player-name {
    font-size: 18px;
    color: #00ff00;
}

.player-status {
    font-size: 14px;
    color: #888;
}

.player-dead {
    opacity: 0.5;
    text-decoration: line-through;
}

.phase-indicator {
    text-align: center;
    font-size: 24px;
    color: #ffff00;
    text-shadow: 0 0 10px #ffff00;
    margin: 20px 0;
    padding: 15px;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 8px;
}

.role-card {
    background: linear-gradient(135deg, #ff0000, #cc0000);
    border: 2px solid #ffff00;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    text-align: center;
}

.role-card h2 {
    color: #ffff00;
    margin-bottom: 10px;
}

.role-card p {
    color: #fff;
    font-size: 14px;
}

.action-panel {
    margin: 20px 0;
    padding: 20px;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 8px;
}

.action-panel h3 {
    color: #00ff00;
    margin-bottom: 15px;
}

.target-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.target-btn {
    padding: 10px 20px;
    background: rgba(0, 100, 200, 0.8);
    color: #fff;
    border: 1px solid #00ff00;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s;
}

.target-btn:hover {
    background: rgba(0, 150, 255, 1);
    transform: scale(1.05);
}

.target-btn.selected {
    background: #00ff00;
    color: #000;
    font-weight: bold;
}

.game-log {
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid #00ff00;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    max-height: 300px;
    overflow-y: auto;
}

.log-entry {
    color: #00ff00;
    padding: 5px 0;
    border-bottom: 1px solid rgba(0, 255, 0, 0.2);
}

.investigation-result {
    background: linear-gradient(135deg, #0088ff, #0066cc);
    border: 2px solid #ffff00;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    text-align: center;
    color: #fff;
}

.hidden {
    display: none;
}

.winner-announcement {
    background: linear-gradient(135deg, #ffff00, #ffcc00);
    border: 3px solid #ff0000;
    border-radius: 10px;
    padding: 30px;
    text-align: center;
    color: #000;
    font-size: 24px;
    font-weight: bold;
    margin: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="mafia-container">
    <div class="game-header">
        <a href="/" class="btn btn-secondary">‚¨ÖÔ∏è Home</a>
        <h1>üïµÔ∏è Mafia Game</h1>
        <div></div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby" class="lobby-screen">
        <h2>Join or Create a Game</h2>
        <div class="join-controls">
            <input type="text" id="player-name" placeholder="Your Name" maxlength="20">
            <input type="text" id="room-code" placeholder="Room Code" maxlength="6">
            <button class="btn" onclick="joinGame()">Join Game</button>
        </div>
        <p style="color: #888; text-align: center;">Enter a room code to join, or create a new one!</p>
    </div>

    <!-- Game Screen -->
    <div id="game-area" class="game-screen hidden">
        <!-- Room Info -->
        <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="color: #00ff00;">Room: <span id="display-room-code"></span></h3>
        </div>

        <!-- Phase Indicator -->
        <div id="phase-display" class="phase-indicator">Waiting for players...</div>

        <!-- Role Card (only shown to player) -->
        <div id="role-card" class="role-card hidden">
            <h2>Your Role: <span id="player-role"></span></h2>
            <p id="role-description"></p>
        </div>

        <!-- Investigation Result -->
        <div id="investigation-result" class="investigation-result hidden"></div>

        <!-- Action Panel -->
        <div id="action-panel" class="action-panel hidden">
            <h3 id="action-title">Choose your action</h3>
            <div id="action-buttons" class="target-buttons"></div>
            <button class="btn" onclick="confirmAction()" style="margin-top: 15px;">Confirm Action</button>
        </div>

        <!-- Players List -->
        <div class="players-list">
            <h3 style="color: #00ff00;">Players</h3>
            <div id="players-container"></div>
        </div>

        <!-- Game Log -->
        <div class="game-log">
            <h4 style="color: #00ff00; margin-bottom: 10px;">Game Log</h4>
            <div id="log-container"></div>
        </div>

        <!-- Controls -->
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="start-game-btn" class="btn" onclick="startGame()">Start Game</button>
            <button id="start-voting-btn" class="btn hidden" onclick="startVoting()">Start Voting</button>
            <button class="btn btn-secondary" onclick="leaveGame()">Leave Game</button>
        </div>

        <!-- Winner Announcement -->
        <div id="winner-announcement" class="winner-announcement hidden"></div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const socket = io();
let currentRoom = null;
let myPlayerId = null;
let myRole = null;
let selectedTarget = null;

function joinGame() {
    const playerName = document.getElementById('player-name').value.trim();
    const roomCode = document.getElementById('room-code').value.trim() || generateRoomCode();
    
    if (!playerName) {
        alert('Please enter your name');
        return;
    }
    
    currentRoom = roomCode;
    socket.emit('mafia_join', { room_code: roomCode, player_name: playerName });
}

function generateRoomCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
}

function startGame() {
    socket.emit('mafia_start', { room_code: currentRoom });
}

function startVoting() {
    socket.emit('mafia_start_voting', { room_code: currentRoom });
}

function selectTarget(targetId) {
    selectedTarget = targetId;
    
    // Highlight selected button
    document.querySelectorAll('.target-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    event.target.classList.add('selected');
}

function confirmAction() {
    if (!selectedTarget) {
        alert('Please select a target');
        return;
    }
    
    const phase = document.getElementById('phase-display').textContent;
    
    if (phase.includes('Night')) {
        // Determine action based on role
        let action = '';
        if (myRole === 'mafia') action = 'kill';
        else if (myRole === 'doctor') action = 'save';
        else if (myRole === 'detective') action = 'investigate';
        
        socket.emit('mafia_night_action', {
            room_code: currentRoom,
            action: action,
            target: selectedTarget
        });
    } else if (phase.includes('Voting')) {
        socket.emit('mafia_vote', {
            room_code: currentRoom,
            target: selectedTarget
        });
    }
    
    selectedTarget = null;
}

function leaveGame() {
    socket.emit('mafia_leave', { room_code: currentRoom });
    currentRoom = null;
    document.getElementById('lobby').classList.remove('hidden');
    document.getElementById('game-area').classList.add('hidden');
}

// Socket event handlers
socket.on('mafia_joined', (data) => {
    document.getElementById('lobby').classList.add('hidden');
    document.getElementById('game-area').classList.remove('hidden');
    document.getElementById('display-room-code').textContent = data.room_code;
});

socket.on('mafia_state', (state) => {
    updateGameState(state);
});

socket.on('mafia_started', () => {
    document.getElementById('start-game-btn').classList.add('hidden');
});

socket.on('mafia_action_confirmed', () => {
    document.getElementById('action-panel').classList.add('hidden');
    alert('Action submitted!');
});

socket.on('mafia_vote_confirmed', () => {
    document.getElementById('action-panel').classList.add('hidden');
    alert('Vote submitted!');
});

socket.on('mafia_game_over', (data) => {
    const winner = data.winner === 'villagers' ? 'üë• Villagers Win!' : 'üî™ Mafia Wins!';
    document.getElementById('winner-announcement').textContent = winner;
    document.getElementById('winner-announcement').classList.remove('hidden');
});

socket.on('mafia_error', (data) => {
    alert('Error: ' + data.error);
});

function updateGameState(state) {
    // Update phase display
    document.getElementById('phase-display').textContent = 
        state.phase === 'lobby' ? 'Waiting for players...' :
        state.phase === 'night' ? `üåô Night ${state.round}` :
        state.phase === 'day' ? `‚òÄÔ∏è Day ${state.round}` :
        state.phase === 'voting' ? 'üó≥Ô∏è Voting Phase' :
        'üèÅ Game Over';
    
    // Update players list
    const playersContainer = document.getElementById('players-container');
    playersContainer.innerHTML = '';
    
    state.players.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card' + (player.alive ? '' : ' player-dead');
        playerCard.innerHTML = `
            <div class="player-name">${player.name}</div>
            <div class="player-status">${player.alive ? '‚úÖ Alive' : 'üíÄ Dead'}</div>
        `;
        playersContainer.appendChild(playerCard);
        
        // Save my role
        if (player.role) {
            myRole = player.role;
            document.getElementById('player-role').textContent = player.role.toUpperCase();
            document.getElementById('role-card').classList.remove('hidden');
            
            const descriptions = {
                'mafia': 'Eliminate villagers during the night. Win when you equal or outnumber them.',
                'doctor': 'Save one player each night from the Mafia.',
                'detective': 'Investigate one player each night to discover if they are Mafia.',
                'villager': 'Find and eliminate the Mafia during day voting.'
            };
            document.getElementById('role-description').textContent = descriptions[player.role] || '';
        }
    });
    
    // Update action panel
    if (state.phase === 'night' && myRole && myRole !== 'villager') {
        showActionPanel(state.players, 'night');
    } else if (state.phase === 'voting') {
        showActionPanel(state.players, 'voting');
        document.getElementById('start-voting-btn').classList.add('hidden');
    } else {
        document.getElementById('action-panel').classList.add('hidden');
        
        if (state.phase === 'day') {
            document.getElementById('start-voting-btn').classList.remove('hidden');
        }
    }
    
    // Show investigation result
    if (state.investigation_result) {
        const result = state.investigation_result;
        document.getElementById('investigation-result').textContent = 
            `Investigation: ${result.target} is ${result.is_mafia ? 'MAFIA üî™' : 'NOT MAFIA ‚úÖ'}`;
        document.getElementById('investigation-result').classList.remove('hidden');
    }
    
    // Update game log
    const logContainer = document.getElementById('log-container');
    logContainer.innerHTML = '';
    state.log.forEach(entry => {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.textContent = entry;
        logContainer.appendChild(logEntry);
    });
    
    // Scroll log to bottom
    logContainer.scrollTop = logContainer.scrollHeight;
}

function showActionPanel(players, phase) {
    document.getElementById('action-panel').classList.remove('hidden');
    
    const actionButtons = document.getElementById('action-buttons');
    actionButtons.innerHTML = '';
    
    const actionTitle = document.getElementById('action-title');
    if (phase === 'night') {
        if (myRole === 'mafia') actionTitle.textContent = 'üî™ Choose a target to kill';
        else if (myRole === 'doctor') actionTitle.textContent = 'üíâ Choose a player to save';
        else if (myRole === 'detective') actionTitle.textContent = 'üîç Choose a player to investigate';
    } else if (phase === 'voting') {
        actionTitle.textContent = 'üó≥Ô∏è Vote to eliminate';
    }
    
    // Create target buttons
    players.forEach(player => {
        if (player.alive && player.id !== socket.id) {
            const btn = document.createElement('button');
            btn.className = 'target-btn';
            btn.textContent = player.name;
            btn.onclick = () => selectTarget(player.id);
            actionButtons.appendChild(btn);
        }
    });
}
</script>
{% endblock %}
