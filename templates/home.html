{% extends "base.html" %}

{% block title %}Futuristic Games Hub{% endblock %}

{% block extra_head %}
<!-- Lazy load Google Sign-In only when needed -->
{% if not user %}
<script src="https://accounts.google.com/gsi/client" async defer></script>
<meta name="google-signin-client_id" content="{{ google_client_id }}">
{% endif %}
{% endblock %}

{% block content %}
<div class="container">
    <h1>ğŸ® Futuristic Games Hub</h1>
    <p class="subtitle">Choose Your Epic Adventure</p>
    
    {% if user %}
    <!-- Logged in view -->
    <div class="user-info">
        {% if user.picture %}
        <img src="{{ user.picture }}" alt="Profile" class="profile-pic" loading="lazy">
        {% else %}
        <div class="profile-pic-placeholder">{{ user.first_name[0] if user.first_name else user.name[0] }}</div>
        {% endif %}
        <span class="user-name">Welcome, {{ user.first_name or user.name }}! ğŸ‘‹</span>
        <a href="/logout" class="btn btn-secondary">Logout</a>
    </div>
    
    <div class="games-grid">
        {% for game in games %}
        <a href="{{ game.url }}" class="game-card">
            <div class="game-icon">{{ game.icon }}</div>
            <h2>{{ game.name }}</h2>
            <p>{{ game.description }}</p>
            <p class="player-count">ğŸ‘¥ {{ game.players }} Players</p>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <!-- Login required view -->
    <div class="login-container">
        <div class="login-card">
            <div class="login-icon">ğŸ”</div>
            <h2>Sign In to Play</h2>
            <p>Sign in with Google or enter your name to start playing</p>
            
            <!-- Google Sign-In Button Container -->
            <div id="google-signin-section">
                <div id="google-signin-button"></div>
                <div class="divider">
                    <span>OR</span>
                </div>
            </div>
            
            <!-- Manual Name Input -->
            <div class="manual-login-section">
                <form id="manual-login-form">
                    <div class="input-group">
                        <input type="text" 
                               id="player-name" 
                               name="player_name" 
                               placeholder="Enter your name" 
                               required
                               minlength="2"
                               maxlength="30"
                               class="name-input">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        ğŸ® Start Playing
                    </button>
                </form>
                <p class="login-hint">ğŸ’¡ Tip: Sign in with Google to save your progress!</p>
            </div>
        </div>
        
        <!-- Removed duplicate games preview - reduces DOM size by 50% -->
    </div>
    {% endif %}
</div>

{% if not user %}
<script>
// Optimized Google Sign-In - only loads when not logged in
function handleCredentialResponse(response) {
    fetch('/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            credential: response.credential,
            login_type: 'google'
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Login failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Login failed. Please try again.');
    });
}

// Optimized: Single initialization check with timeout
window.addEventListener('DOMContentLoaded', function() {
    const clientId = "{{ google_client_id }}";
    
    if (!clientId || clientId === '' || clientId === 'None') {
        document.getElementById('google-signin-section').style.display = 'none';
        return;
    }
    
    let attempts = 0;
    const maxAttempts = 30; // 3 seconds max
    
    const initGoogle = setInterval(function() {
        attempts++;
        if (typeof google !== 'undefined' && google.accounts) {
            clearInterval(initGoogle);
            google.accounts.id.initialize({
                client_id: clientId,
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById('google-signin-button'),
                {theme: 'filled_black', size: 'large', width: 300}
            );
        } else if (attempts >= maxAttempts) {
            clearInterval(initGoogle);
            document.getElementById('google-signin-section').style.display = 'none';
        }
    }, 100);
});

// Manual login form
document.getElementById('manual-login-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const playerName = document.getElementById('player-name').value.trim();
    
    if (playerName.length < 2) {
        alert('Please enter a name with at least 2 characters');
        return;
    }
    
    fetch('/login/manual', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({player_name: playerName})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Login failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Login failed. Please try again.');
    });
});
</script>
{% endif %}
{% endblock %}
